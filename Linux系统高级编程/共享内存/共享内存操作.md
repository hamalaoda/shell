## 1、创建共享内存

`shmget`是Linux系统中用与**创建或获取共享<font color='red'>内存段</font>**的系统调用，是共享内存IPC机制的核心接口。它负责向内存核申请一块共享内存，并返回一个唯一的标识符（共享内存 ID），供后续操作（映射、读写等）使用。

#### **shmget函数原型**

```c
#include <sys/ipc.h> 
#include <sys/shm.h> 
int shmget(key_t key, size_t size, int shmflg);
```

#### 功能：

开辟system V 共享内存空间

#### 参数：

- 参数1：key值，标识共享内存使用范围

  - IPC_PRIVATE：所创建的共享内存为私有共享内存，只能用于具有亲缘关系进程间通信；

  - 非IPC_PRIVATE：标识唯一共享内存，可以用于任意进程间通信。

- 参数2：size指定共享内存空间的大小

- 参数3：shmflg设置共享内存的行为和访问权限

  - PC_CREAT：创建共享标识符，共享内存不存在则创建并获取共享内存，存在则直接获取共享内存；

  - IPC_EXCL：在创建共享内存的时候使用，表示共享内存已存在则报错，否则创建。

  - 访问权限的设置和open函数一致。

#### 返回值：

​	成功返回共享内存的标识符ID，失败返回-1且设置errno的值

#### 示例：

```c
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>

int main(int argc, char const *argv[])

{
  /* 获取IPC对象键值key*/
  key_t key; // 连接文件，生成唯一标识符
  int shmid;
  char *shmaddr; //
  key = ftok(".", 65);
  if (key == -1)
  {
    perror("ftok failed");
    return -1;
  }
  /*创建共享内存 不存在则创建存在则获取*/
  shmid = shmget(key, 1024, IPC_CREAT | 0777);
  if (shmid == -1)
  {
    perror("shmget failed");
    return -1;
  }
  return 0;
}
```

查看共享内存

ipcs -m

删除共享内存

ipcrm -m shmid

## 2、共享内存映射

`shmat`是Linux系统中用于**将共享内存映射到当前进程虚拟地址空间**的系统调用。通过shmget获取到共享内存ID后，必须使用shmat建设映射，进程才能访问共享内存中的数据。

空间。

#### shmat函数原型

```c
#include <sys/types.h> 
#include <sys/shm.h> 
void *shmat(int shmid, const void *shmaddr, int shmflg);
```

#### 功能：

​	将指定共享内存映射到用户空间；

#### 参数：

参数1：

​	shmid标识所要映射共享内存的ID

参数2：

​	shmaddr表示指定共享内存映射到进程虚拟地址空间的**起始地址**。

1) 手动映射：指的是用户空间的地址由用户设置，需要开辟足够的用户空间并将起始地址传递进行映射。
2) 自动映射：指的是由系统进程分配映射成功的用户空间地址，不需要用户空间创建，直接设置为NULL

参数3：shmflg设置共享内存的访问权限

​	0	：可读可写访问

​	SHM_RDONLY	：只读访问权限；

​	SHM_REMAP	： 若 `shmaddr` 已映射到其他内存，替换原有映射（需 `shmaddr` 非 `NULL`）。

标志位可组合使用（如 `SHM_RDONLY | SHM_REMAP`）。

#### 返回值：

​	成功：返回共享内存映射到进程虚拟地址空间的**起始地址指针**（`void *` 类型，可强制转换为具体数据类型的指针使用）。

​	失败：返回<font color='red'>(void *) -1</font>且修改errno的值。

#### 示例：

```c
#include <stdio.h>
#include <sys/types.h>
#include <sys/shm.h>
int main(int argc, char const *argv[])
{

  key_t key;
  int shmid;
  char *shmaddr;
  /*获取IPC对象键值*/
  key = ftok(".", 65);
  if (key == -1)
  {
    perror("ftok failed");
    return -1;
  }
  /*创建共享内存*/ // 返回共享内存id
  shmid = shmget(key, 1024, IPC_CREAT | 0777);
  if (shmid == -1)
  {
    perror("shmget failed");
    return -1;
  }
  /*映射共享内存*/ // 默认null由系统分配虚拟内存
  shmaddr = (char *)shmat(shmid, NULL, 0);
  if (shmaddr == (void *)-1
  {
   perror("shmat failed");
    return -1;
  }
  /*共享内存解映射*/

  if (shmdt(shmaddr) == -1)
  {
    perror("shmdt");
     return -1;
  }

  return 0;
}
```

## 3、共享内存的控制

#### shmctl函数原型

```c
#include <sys/ipc.h>
 #include <sys/shm.h> 
int shmctl(int shmid, int cmd, struct shmid_ds *buf);
```

#### 功能：

​	system V 共享内存的控制，主要用于设置或者获取共享内存的属性，以及删除共享内存

#### 参数：

​	参数1：shmid共享内存的标识符ID；

​	参数2：cmd控制命令

IPC_STAT	：获取共享内存的属性

IPC_SET	：设置共享内存的属性

IPC_RMID	：删除共享内存

SHM_LOCK 	：锁定共享内存段(超级用户)。

SHM_UNLOCK	：解锁共享内存段。

​	参数3：buf存储共享内存属性（所要设置或者所获取的属性）shmid_ds 数据类型的地址，用来存放或修改共享内存的属性。

#### **返回值：** 

成功返回 0，失败返回 -1。

##### 实例：
